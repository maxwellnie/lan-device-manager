# LanDevice Manager Windows 客户端开发报告

## 项目概述
基于 Tauri 2.0 + React + TypeScript 开发的 Windows 桌面应用，用于局域网设备管理，提供 API 服务器、WebSocket 实时通信、mDNS 服务发现等功能。

---

## 已完成的功能

### 1. UI 界面优化

#### 玻璃主题效果 (Glass Theme)
- **实现内容**: Win10/Win11 适配的透明度效果
- **相关文件**: 
  - `src/App.tsx`
  - `src/components/TitleBar.tsx`
- **技术要点**: 
  - 使用 CSS backdrop-filter 实现毛玻璃效果
  - 适配 Windows Mica/Acrylic 材质
  - 左侧面板和日志区域透明度统一调整

#### macOS 风格窗口控制按钮
- **实现内容**: 彩色圆形按钮（最小化-黄色、最大化-绿色、关闭-红色）
- **位置**: 窗口右上角
- **相关文件**: `src/components/TitleBar.tsx`

#### 主题持久化
- **问题**: 主题切换后重启应用未保存
- **原因**: `save_config` 函数中未保存 `theme` 字段
- **修复**: `src-tauri/src/lib.rs` 第232行添加 `cfg.theme = new_config.theme;`
- **状态**: 已修复

---

### 2. 服务器功能

#### 端口变更自动重启
- **问题**: 修改端口号后重启服务器，端口号仍为原值
- **实现**: 
  - 前端添加 `restartServer` 函数 (`src/App.tsx` 第320行)
  - 设置组件添加 `onServerRestart` 回调
- **流程**: 停止服务器 → 重新加载配置 → 使用新端口启动
- **状态**: 已实现

#### mDNS 服务发现
- **服务类型**: `_lanmanager._tcp.local.`
- **功能**: 广播设备信息，供 Android 端扫描发现
- **属性包含**: 
  - `version`: 应用版本
  - `protocol`: tcp
  - `auth`: required
  - `device`: 主机名
  - `uuid`: 设备唯一标识
  - `port`: 服务端口号

---

### 3. 命令执行系统

#### 命令白名单机制
- **设计**: 双层验证机制
  - "custom" 作为主开关（master switch）
  - 具体命令名（如 "ping", "ipconfig"）作为子权限
- **相关文件**: `src-tauri/src/command.rs`

#### 自定义命令支持
- **问题 1**: 添加 ping 到白名单后仍无法执行
- **原因**: 未添加 "custom" 到白名单
- **修复**: `src/components/Settings.tsx` 自动添加 "custom" 到白名单

- **问题 2**: `ping 127.0.0.1` 提示不在白名单
- **原因**: Android 端发送格式为 `{"command": "custom", "args": ["ping 127.0.0.1"]}`，需要解析拆分
- **修复**: `src-tauri/src/api.rs` 添加命令解析逻辑：
  ```rust
  if req.command == "custom" {
      if let Some(args) = &req.args {
          if let Some(first_arg) = args.first() {
              let parts: Vec<&str> = first_arg.split_whitespace().collect();
              // 拆分为命令和参数
          }
      }
  }
  ```
- **状态**: 已修复

---

### 4. Android 端设备扫描问题修复

#### 问题描述
Windows 端修改端口后，Android 端无法扫描到设备

#### 根本原因
1. mDNS 服务停止时未主动注销，导致网络缓存旧记录
2. 服务名称固定为 `"lan-device-manager"`，可能产生冲突

#### 修复方案 `src-tauri/src/mdns.rs`

1. **服务注销机制**:
   ```rust
   pub fn stop(&self) -> Result<(), Box<dyn std::error::Error>> {
       // 先注销服务，通知网络中的其他设备
       let full_service_name = format!("{}.{}", self.service_name, self.service_type);
       self.daemon.unregister(&full_service_name)?;
       
       // 给注销消息一些时间传播
       std::thread::sleep(std::time::Duration::from_millis(100));
       
       // 然后关闭 daemon
       self.daemon.shutdown()?;
   }
   ```

2. **唯一服务名称**:
   - 使用设备 UUID 前 8 位生成唯一服务名（如 `LanDevice-a1b2c3d4`）
   - 避免多设备或服务重启时的命名冲突

3. **端口信息广播**:
   - 在 mDNS 属性中添加 `port` 字段
   - Android 端可直接获取正确端口号

#### 状态: 已修复

---

## 技术架构

### 后端 (Rust)
| 模块 | 功能 |
|------|------|
| `src-tauri/src/api.rs` | HTTP API 端点（Axum 框架） |
| `src-tauri/src/auth.rs` | Argon2 密码哈希 + JWT 认证 |
| `src-tauri/src/command.rs` | 命令执行与白名单检查 |
| `src-tauri/src/config.rs` | 配置持久化 |
| `src-tauri/src/mdns.rs` | mDNS 服务发现 |
| `src-tauri/src/websocket.rs` | WebSocket 实时通信 |
| `src-tauri/src/state.rs` | 应用状态管理 |

### 前端 (React + TypeScript)
| 组件 | 功能 |
|------|------|
| `src/App.tsx` | 主应用逻辑、主题管理 |
| `src/components/TitleBar.tsx` | 自定义标题栏、窗口控制 |
| `src/components/Settings.tsx` | 设置面板 |
| `src/components/LogPanel.tsx` | 日志显示 |
| `src/components/ServerCard.tsx` | 服务器状态卡片 |

---

## 配置文件

**路径**: `%APPDATA%/LanDeviceManager/config.json`

```json
{
  "api_port": 8080,
  "auto_start_api": true,
  "auto_start_on_boot": false,
  "command_whitelist": ["systeminfo", "ping", "custom"],
  "custom_commands": ["ping 127.0.0.1"],
  "theme": "glass",
  "enable_log_file": true,
  "log_buffer_size": 500
}
```

---

## 待优化项目

1. **托盘菜单国际化** - 当前为英文，需根据系统语言切换
2. **日志文件轮转** - 当前仅限制单文件大小，需添加多文件轮转
3. **WebSocket 安全性** - 添加更严格的 Origin 检查

---

## 构建命令

```bash
# 开发模式
cd d:/lan-device-manager/lan-windows
npm run tauri dev

# 生产构建
npm run tauri build
```

---

报告生成时间: 2026-02-15
